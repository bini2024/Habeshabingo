<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HABESHA Bingo community</title>
    <meta name="description" content="Lightweight online bingo you can host with friends. Cards generate in-browser. Caller & player views. No login.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   <style>
    :root {
        --bg-start: #000000; /* Darker black */
        --bg-end: #0a1128;   /* Deep subtle blue */
        --panel-bg: rgba(255, 255, 255, 0.05); /* Slightly transparent for depth */
        --panel-border: rgba(255, 255, 255, 0.1);
        --text-color: #e0e7ff; /* Soft white-blue for text */
        --muted-text: #aab8d0; /* Lighter muted text */
        --brand-blue: #4a90e2; /* Modern vibrant blue */
        --brand-highlight: #74b9ff; /* Brighter blue for accents */
        --accent-green: #50c878; /* Consistent green for success */
        --danger-red: #ef4444; /* Standard red for danger */
        --warning-orange: #f59e0b; /* Standard orange for warning */
        --ring-focus: rgba(74, 144, 226, 0.4); /* Blue focus ring */
        --card-bg: rgba(255, 255, 255, 0.03); /* Subtle card background */
        --grid-bg: rgba(255, 255, 255, 0.07); /* Slightly more prominent grid bg */
        --shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3); /* Softer, modern shadow */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
        color: var(--text-color);
        /* Modern blue to black gradient background */
        background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
        min-height: 100vh; /* Ensure gradient covers full height */
        display: flex;
        flex-direction: column;
    }
    a { color: var(--brand-blue); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container { max-width: 1100px; margin: 0 auto; padding: 24px; flex-grow: 1; display: flex; flex-direction: column; }
    .app {
        display: grid; gap: 20px; grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px) { .app { grid-template-columns: 1fr; } }

    .card {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(5px); /* Adds a subtle frosted glass effect */
        -webkit-backdrop-filter: blur(5px);
    }
    .panel { padding: 22px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 8px; }
    h1 { font-size: 28px; margin: 0; letter-spacing: .4px; color: var(--brand-highlight); }
    h3 { color: var(--brand-highlight); } /* Apply highlight to subheadings */
    .tag { font-size: 12px; color: var(--muted-text); background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .input, select, textarea {
        width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--panel-border);
        background:rgba(255,255,255,.07); color:var(--text-color); outline:none; transition:border .2s, box-shadow .2s;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; /* Ensure consistent font */
    }
    .input:focus, select:focus, textarea:focus { border-color: var(--brand-blue); box-shadow: 0 0 0 4px var(--ring-focus); }
    label { font-size:13px;color:var(--muted-text)}
    .btn {
        display:inline-flex;align-items:center;justify-content:center;gap:8px;
        padding:12px 16px;border-radius:12px;border:1px solid var(--panel-border);
        background:linear-gradient(180deg, rgba(74,144,226,.3), rgba(74,144,226,.1)); /* Blue gradient */
        color:var(--text-color); cursor:pointer; user-select:none; font-weight:600; letter-spacing:.25px;
        box-shadow:var(--shadow);
        transition: all .2s ease;
    }
    .btn:hover{filter:brightness(1.1); transform: translateY(-1px);}
    .btn.secondary{background:rgba(255,255,255,.1); border-color: rgba(255,255,255,.15);}
    .btn.secondary:hover { background: rgba(255,255,255,.15); }
    .btn.success{background:linear-gradient(180deg, rgba(80,200,120,.4), rgba(80,200,120,.15)); border-color: rgba(80,200,120,.4);} /* Green */
    .btn.success:hover { background: linear-gradient(180deg, rgba(80,200,120,.5), rgba(80,200,120,.2)); }
    .btn.warn{background:linear-gradient(180deg, rgba(245,158,11,.35), rgba(245,158,11,.12)); border-color: rgba(245,158,11,.45);} /* Orange */
    .btn.warn:hover { background: linear-gradient(180deg, rgba(245,158,11,.45), rgba(245,158,11,.18)); }
    .btn.danger{background:linear-gradient(180deg, rgba(239,68,68,.35), rgba(239,68,68,.12)); border-color: rgba(239,68,68,.45);} /* Red */
    .btn.danger:hover { background: linear-gradient(180deg, rgba(239,68,68,.45), rgba(239,68,68,.18)); }
    .btn:disabled{
        opacity:0.5;
        cursor:not-allowed;
        filter:none;
        transform: none;
    }

    .grid{display:grid; grid-template-columns: repeat(5, 1fr); gap:8px}
    .bingo-card{padding:18px;background:var(--card-bg); border:1px solid var(--panel-border); border-radius:20px}
    .bingo-head div{font-size:18px;font-weight:800;text-align:center;background:rgba(255,255,255,.1); padding:10px;border-radius:12px;letter-spacing:2px; color: var(--brand-highlight);}
    .cell{position:relative; text-align:center; padding:16px 6px; border-radius:14px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); font-size:18px; font-weight:700; cursor:pointer; transition:transform .1s ease, background .2s ease, border-color .2s ease}
    .cell:hover{transform:translateY(-1px); background:rgba(255,255,255,.08);}
    .cell.called{background:linear-gradient(180deg, rgba(74,144,226,.3), rgba(74,144,226,.1)); border-color:var(--brand-blue);} /* Called blue */
    .cell.called:hover { background:linear-gradient(180deg, rgba(74,144,226,.4), rgba(74,144,226,.15)); }
    .cell.marked{background:linear-gradient(180deg, rgba(80,200,120,.4), rgba(80,200,120,.15)); border-color: var(--accent-green); box-shadow: inset 0 0 0 3px rgba(80,200,120,.35);} /* Marked green */
    .cell.marked:hover { background:linear-gradient(180deg, rgba(80,200,120,.5), rgba(80,200,120,.2)); }
    .cell.free{background:linear-gradient(180deg, rgba(116,185,255,.35), rgba(116,185,255,.08)); border-color: var(--brand-highlight);} /* Free space light blue */
    .cell.free:hover { background:linear-gradient(180deg, rgba(116,185,255,.45), rgba(116,185,255,.12)); }

    .kicker{font-size:12px;color:var(--muted-text)}
    .muted{color:var(--muted-text)}
    .callout{padding:14px;border-radius:14px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1); color: var(--text-color);}
    .callout strong { color: var(--brand-highlight); }
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:16px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);font-size:12px; color: var(--text-color);}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:20px}
    @media (max-width: 740px){ .split{grid-template-columns:1fr} }
    .board{display:grid;grid-template-columns: repeat(15, 1fr); gap:8px}
    .num{padding:10px 0;text-align:center;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:var(--grid-bg);font-weight:700}
    .num.hit{background:linear-gradient(180deg, rgba(74,144,226,.35), rgba(74,144,226,.12));border-color:var(--brand-blue);} /* Hit numbers blue */
    .last-call{font-size:72px; font-weight:900; text-align:center; letter-spacing:2px; margin:0; color: var(--brand-highlight);}
    @media (max-width: 740px){ .last-call{font-size:48px} }
    .switch{display:inline-flex; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15); border-radius:12px; overflow:hidden}
    .switch button{border:0;background:transparent;color:var(--text-color);padding:10px 14px;cursor:pointer;font-weight:700; transition: background .2s ease;}
    .switch button.active{background:var(--brand-blue); color: white;}
    .switch button:hover:not(.active) { background: rgba(255,255,255,.15); }
    .hidden{display:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .prize-display{font-size:2em; font-weight:bold; color:var(--accent-green)} /* Prize in green */

    /* Dialog styling */
    dialog {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: var(--text-color);
        padding: 22px;
        max-width: 500px;
    }
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(3px);
    }
    dialog h3 { color: var(--brand-highlight); }
    dialog p, dialog ul, dialog ol { color: var(--muted-text); }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> HABESHA Bingo</h1>
            <div class="row">
                <span class="tag">Bingo</span>
            </div>
        </div>

        <div class="app">
            <div class="card panel" id="left">
                <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:12px">
                    <div class="switch" role="tablist" aria-label="Mode switch">
                        <button id="tabPlayer" class="active" onclick="switchTab('player')">Player</button>
                        <button id="tabHost" onclick="switchTab('host')">Host/Caller</button>
                    </div>
                    <div class="row">
                        <button class="btn secondary" onclick="openModal('rulesModal')">Rules</button>
                        <button class="btn secondary" onclick="openModal('payoutModal')">E‚ÄëTransfer Info</button>
                    </div>
                </div>

                <section id="playerView">
                    <div class="split">
                        <div>
                            <div class="row">
                                <div style="flex:1">
                                    <label for="playerName">Your name</label>
                                    <input id="playerName" class="input" placeholder="e.g., Biniam" />
                                </div>
                                <div style="flex:1">
                                    <label for="gameId">Game ID (host shares)</label>
                                    <input id="gameId" class="input mono" placeholder="e.g., 482913" />
                                </div>
                                <div style="flex:1">
                                    <label for="gameKey">Game Key (host gives you)</label>
                                    <input id="gameKey" class="input mono" placeholder="e.g., secret-key" />
                                </div>
                            </div>
                            <div class="row" style="margin-top:10px">
                                <button id="generateBtn" class="btn" onclick="generateCard()" disabled>Generate Card</button>
                                <button class="btn secondary" onclick="resetCard()">Reset</button>
                                <button class="btn success" onclick="claimBingo()">Claim Bingo</button>
                            </div>
                            <p class="kicker">Tip: Enter the Game ID and Game Key from your host to get a unique, valid card.</p>
                            <div id="cardDetails" class="muted" style="margin-top: 10px; font-size: 14px;"></div>
                            <div id="cardArea" class="bingo-card" aria-live="polite" style="margin-top:14px">
                                <div class="grid bingo-head" aria-hidden="true">
                                    <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
                                </div>
                                <div id="cardGrid" class="grid" style="margin-top:8px"></div>
                            </div>
                            <div class="footer">
                                <span id="status" class="badge">No bingo yet</span>
                                <div class="row">
                                    <button class="btn warn" onclick="togglePaste()">Paste Called #</button>
                                    <button class="btn secondary" onclick="downloadCardPNG()">Download PNG</button>
                                </div>
                            </div>

                            <div id="pasteWrap" class="hidden" style="margin-top:10px">
                                <label for="pasteInput">Paste called numbers (comma or space separated)</label>
                                <textarea id="pasteInput" class="input" rows="2" placeholder="e.g., B5, 17, N31, 73 ..."></textarea>
                                <div class="row" style="margin-top:8px">
                                    <button class="btn" onclick="applyCalledFromPaste()">Apply</button>
                                    <button class="btn secondary" onclick="clearCalled()">Clear</button>
                                </div>
                            </div>

                        </div>

                        <aside>
                            <div class="callout">
                                <strong>How to play</strong>
                                <ol style="margin:10px 0 0 18px; color:var(--muted)">
                                    <li>Ask the host for the <b>Game ID</b>, <b>Game Key</b> & entry fee.</li>
                                    <li>Send entry via <b>e‚ÄëTransfer</b> (see E‚ÄëTransfer Info).</li>
                                    <li>Generate your card & join the live stream.</li>
                                    <li>Tap numbers as they are called. We auto-detect lines.</li>
                                    <li>Hit <b>Claim Bingo</b> and send screenshot to host.</li>
                                </ol>
                            </div>
                            <div class="callout" style="margin-top:12px">
                                <strong>Winning patterns</strong>
                                <ul style="margin:10px 0 0 18px; color:var(--muted)">
                                    <li>Single Line (row/column/diagonal)</li>
                                    <li>Double Line</li>
                                    <li>Full House (all cells)</li>
                                </ul>
                            </div>
                        </aside>
                    </div>
                </section>

                <section id="hostView" class="hidden">
                    <div class="row">
                        <div style="flex:1">
                            <label for="hostGameId">Game ID</label>
                            <input id="hostGameId" class="input mono" placeholder="e.g., 482913" />
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <div class="row">
                                <button class="btn" onclick="startCaller()">Start / Reset</button>
                                <button class="btn secondary" onclick="copyShare()">Copy Share Text</button>
                            </div>
                        </div>
                    </div>

                    <div class="card panel" style="margin-top:16px">
                        <h3 style="margin:0 0 8px 0">Caller</h3>
                        <p id="hostHint" class="muted" style="margin:0 0 10px 0">Enter a Game ID and press <b>Start</b>. Share the ID with players. Stream this screen when hosting.</p>
                        <div class="row" style="align-items:center;justify-content:space-between;margin:10px 0">
                            <h2 id="lastCall" class="last-call">‚Äî</h2>
                            <div class="row">
                                <button id="btnNext" class="btn success" onclick="drawNext()" disabled>Draw Next</button>
                                <button class="btn danger" onclick="undoCall()" disabled id="btnUndo">Undo</button>
                                <button class="btn secondary" onclick="exportHistory()" disabled id="btnExport">Export</button>
                            </div>
                        </div>
                        <div class="board" id="board"></div>
                        <div style="margin-top:12px">
                            <label>History</label>
                            <div id="history" class="input mono" style="min-height:52px"></div>
                        </div>
                    </div>
                    
                    <div class="card panel" style="margin-top:16px">
                        <h3 style="margin:0 0 8px 0">Card Verifier</h3>
                        <p class="muted" style="margin:0 0 10px 0">Enter a player's name, card ID, and the Game Key to verify their claim.</p>
                        <div class="row">
                            <div style="flex:1">
                                <label for="verifyName">Player Name</label>
                                <input id="verifyName" class="input" placeholder="e.g., Biniam" />
                            </div>
                            <div style="flex:1">
                                <label for="verifyCardID">Card ID</label>
                                <input id="verifyCardID" class="input mono" placeholder="e.g., 32D56" />
                            </div>
                            <div style="flex:1">
                                <label for="verifyGameKey">Game Key</label>
                                <input id="verifyGameKey" class="input mono" placeholder="e.g., secret-key" />
                            </div>
                        </div>
                        <div class="row" style="margin-top:10px">
                            <button class="btn" onclick="verifyCardID()">Verify</button>
                        </div>
                        <div id="verificationStatus" class="callout" style="margin-top:12px; display:none;"></div>
                    </div>
                </section>
            </div>

            <aside class="card panel">
                <h3 style="margin:0 0 8px 0">Prize Calculator</h3>
                <p class="muted" style="margin:0 0 10px 0">Use this to show players the total prize pot based on your game's rules.</p>
                <div class="row">
                    <div style="flex:1">
                        <label for="playerCount">Number of Players</label>
                        <input id="playerCount" class="input" type="number" min="1" value="10" />
                    </div>
                    <div style="flex:1">
                        <label for="entryFee">Fee per Player</label>
                        <input id="entryFee" class="input" type="number" min="1" step="1" value="5" />
                    </div>
                </div>
                <div class="callout" style="margin-top:12px; text-align:center;">
                    <p class="muted" style="margin:0">Total Prize Money (80% of pot)</p>
                    <div id="prizePot" class="prize-display">$0.00</div>
                </div>
                <p class="muted" style="margin-top:12px; text-align:center;">20% of the total pot is a service fee for the host.</p>
            </aside>
        </div>

        <div class="card panel" style="margin-top:16px;">
            <h3 style="margin:0 0 8px 0">Community & Details</h3>
            <p class="muted" style="margin:0 0 12px 0">This app is made to support your community game nights. You can use this space to add your own details.</p>
            
            <div class="callout">
                <div><b>How to Pay</b></div>
                <ol style="margin:8px 0 0 18px; color:var(--muted)">
                    <li>Open your banking app ‚Üí Interac e‚ÄëTransfer.</li>
                    <li>Recipient: **Your Name**</li>
                    <li>Amount: **Your Price** CAD per card.</li>
                    <li>Message: **BINGO + Your Name**</li>
                </ol>
            </div>
            
            <div class="callout" style="margin-top:12px">
                <b>Contact Info</b>
                <p class="muted" style="margin-top:6px;">
                    For questions or to claim your prize, contact the host.
                    <br>
                    Email: your-email@example.com
                    <br>
                    Phone: (555) 555-5555
                </p>
            </div>
        </div>

        <p class="muted" style="margin:18px 6px 0">Built for small community games. Do not use for unlawful gambling. See Policy.</p>
    </div>

    <dialog id="rulesModal" class="card panel">
        <h3 style="margin:0 0 8px 0">Game Rules (Quick)</h3>
        <ul class="muted" style="margin-top:6px">
            <li>75‚Äëball bingo. Columns: B(1‚Äë15), I(16‚Äë30), N(31‚Äë45), G(46‚Äë60), O(61‚Äë75).</li>
            <li>Center is FREE space.</li>
            <li>Winning patterns: Single Line, Double Line, Full House.</li>
            <li>Host calls numbers using the Caller screen and shares a live view.</li>
            <li>Players must mark their own cards and claim wins promptly with a screenshot.</li>
        </ul>
        <div class="row" style="margin-top:10px;justify-content:flex-end"><button class="btn" onclick="closeModal('rulesModal')">Close</button></div>
    </dialog>

    <dialog id="payoutModal" class="card panel">
        <h3 style="margin:0 0 8px 0">E‚ÄëTransfer & Prizes</h3>
        <p class="muted">Send your entry via Interac e‚ÄëTransfer before the round starts. Include the Game ID and your name in the message. Payouts are sent by the host after win verification.</p>
        <div class="row" style="margin-top:10px;justify-content:flex-end"><button class="btn" onclick="closeModal('payoutModal')">Close</button></div>
    </dialog>

    <dialog id="policyModal" class="card panel">
        <h3 style="margin:0 0 8px 0">Policy & Disclaimer</h3>
        <p class="muted">This site is for entertainment with friends/community. You are responsible for complying with local laws and platform rules. Keep it friendly and responsible. Suggested age 18+. No refunds after a round begins.</p>
        <div class="row" style="margin-top:10px;justify-content:flex-end"><button class="btn" onclick="closeModal('policyModal')">Close</button></div>
    </dialog>

    <script>
        // This is the secret master key that players must enter to play.
        const HOST_GAME_KEY = "my-secret-key-123";
        // To change it, update the value above.

        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));

        function openModal(id) {
            $("#" + id).showModal();
        }

        function closeModal(id) {
            $("#" + id).close();
        }

        const HOST_PASSWORD = "your-secret-password";
        function switchTab(tab) {
            if (tab === 'host') {
                const password = prompt("Enter the host password:");
                if (password !== HOST_PASSWORD) {
                    alert("Incorrect password. Access denied.");
                    return;
                }
            }
            $("#tabPlayer").classList.toggle('active', tab === 'player');
            $("#tabHost").classList.toggle('active', tab === 'host');
            $("#playerView").classList.toggle('hidden', tab !== 'player');
            $("#hostView").classList.toggle('hidden', tab !== 'host');
        }

        function calculatePrize() {
            const players = parseFloat($("#playerCount").value) || 0;
            const fee = parseFloat($("#entryFee").value) || 0;
            const prize = (players * fee * 0.80).toFixed(2);
            $("#prizePot").textContent = `$${prize}`;
        }

        $$("#playerCount, #entryFee").forEach(el => {
            el.addEventListener('input', calculatePrize);
        });

        function toast(msg) {
            const t = document.createElement('div');
            t.textContent = msg;
            t.setAttribute('role', 'status');
            t.style.position = 'fixed';
            t.style.bottom = '16px';
            t.style.left = '50%';
            t.style.transform = 'translateX(-50%)';
            t.style.padding = '10px 14px';
            t.style.background = 'rgba(0,0,0,.7)';
            t.style.border = '1px solid rgba(255,255,255,.15)';
            t.style.color = 'white';
            t.style.borderRadius = '10px';
            t.style.zIndex = '999';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 1600);
        }

        const cardState = {
            cells: [],
            called: new Set(),
            gridEl: $("#cardGrid"),
            cardID: null,
            playerName: null,
            gameKey: null
        };

        function checkPlayerInputs() {
            const gid = $("#gameId").value.trim();
            const gameKey = $("#gameKey").value.trim();
            const valid = gid.length > 0 && gameKey.length > 0 && gameKey === HOST_GAME_KEY;
            $("#generateBtn").disabled = !valid;
            if(!valid) {
                 $("#cardDetails").innerHTML = `Please enter a valid Game ID and Game Key.`;
            } else {
                 $("#cardDetails").innerHTML = `Press Generate Card to begin!`;
            }
        }

        $$("#gameId, #gameKey").forEach(el => {
            el.addEventListener('input', checkPlayerInputs);
        });

        function buildRanges() {
            return [
                [1, 15],
                [16, 30],
                [31, 45],
                [46, 60],
                [61, 75]
            ];
        }

        function generateColumn(range, count) {
            const [a, b] = range;
            const nums = [];
            for (let i = a; i <= b; i++) nums.push(i);
            const shuffled = nums.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count).sort((x, y) => x - y);
        }

        function generateCard() {
            const name = $("#playerName").value.trim();
            const gid = $("#gameId").value.trim();
            const gameKey = $("#gameKey").value.trim();

            if (!name || name.length < 2) {
                toast('Please enter your name');
                return;
            }
            if (!gid || gid.length < 2) {
                toast('Please enter a Game ID');
                return;
            }
            if (!gameKey || gameKey.length < 2) {
                toast('Please enter the Game Key');
                return;
            }
            
            $("#generateBtn").disabled = true;

            const cardDataString = `${name}|${gid}|${gameKey}`;
            const cardID = btoa(cardDataString).toUpperCase().substring(0, 5);

            cardState.cardID = cardID;
            cardState.playerName = name;
            cardState.gameKey = gameKey;

            const ranges = buildRanges();
            const columns = [
                generateColumn(ranges[0], 5),
                generateColumn(ranges[1], 5),
                generateColumn(ranges[2], 5),
                generateColumn(ranges[3], 5),
                generateColumn(ranges[4], 5),
            ];
            columns[2][2] = 'FREE';

            cardState.cells = [];
            cardState.gridEl.innerHTML = '';
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const idx = r * 5 + c;
                    const val = columns[c][r];
                    const cell = {
                        n: val,
                        marked: val === 'FREE',
                        free: val === 'FREE',
                        r,
                        c
                    };
                    cardState.cells.push(cell);

                    const div = document.createElement('div');
                    div.className = 'cell' + (cell.free ? ' free marked' : '');
                    div.textContent = (cell.n === 'FREE') ? '‚òÖ FREE' : cell.n;
                    div.setAttribute('role', 'button');
                    div.setAttribute('aria-pressed', cell.marked ? 'true' : 'false');
                    div.addEventListener('click', () => toggleMark(idx, div));
                    cardState.gridEl.appendChild(div);
                }
            }
            $("#cardDetails").innerHTML = `<b>Game ID:</b> ${gid} ‚Ä¢ <b>Player:</b> ${name} ‚Ä¢ <b>Card ID:</b> <span class="mono">${cardID}</span>`;
            updateStatus();
            localStorage.setItem('qb_player', JSON.stringify({
                name,
                gid,
                gameKey,
                cardID
            }));
            toast('Card generated');
        }

        function resetCard() {
            cardState.cells = [];
            cardState.gridEl.innerHTML = '';
            $("#status").innerHTML = 'No bingo yet';
            $("#status").style.borderColor = 'rgba(255,255,255,.12)';
            $("#cardDetails").innerHTML = '';
            cardState.cardID = null;
            cardState.playerName = null;
            cardState.gameKey = null;
            $("#generateBtn").disabled = false;
            toast('Card and player data reset.');
        }

        function toggleMark(idx, el) {
            const cell = cardState.cells[idx];
            if (!cell || cell.free) return;
            cell.marked = !cell.marked;
            el.classList.toggle('marked', cell.marked);
            el.setAttribute('aria-pressed', cell.marked ? 'true' : 'false');
            updateStatus();
        }

        function checkLines() {
            if (cardState.cells.length !== 25) return {
                lines: 0,
                full: false
            };
            const marked = (r, c) => cardState.cells[r * 5 + c].marked;
            let lines = 0;
            for (let r = 0; r < 5; r++)
                if ([0, 1, 2, 3, 4].every(c => marked(r, c))) lines++;
            for (let c = 0; c < 5; c++)
                if ([0, 1, 2, 3, 4].every(r => marked(r, c))) lines++;
            if ([0, 1, 2, 3, 4].every(i => marked(i, i))) lines++;
            if ([0, 1, 2, 3, 4].every(i => marked(i, 4 - i))) lines++;
            const full = cardState.cells.every(x => x.marked);
            return {
                lines,
                full
            };
        }

        function updateStatus() {
            const {
                lines,
                full
            } = checkLines();
            const badge = $("#status");
            if (full) {
                badge.innerHTML = 'üéâ FULL HOUSE!';
                badge.style.borderColor = 'rgba(34,197,94,.6)';
            } else if (lines >= 2) {
                badge.innerHTML = '‚ú® DOUBLE LINE!';
                badge.style.borderColor = 'rgba(124,156,255,.6)';
            } else if (lines >= 1) {
                badge.innerHTML = '‚úÖ SINGLE LINE!';
                badge.style.borderColor = 'rgba(124,156,255,.6)';
            } else {
                badge.innerHTML = 'No bingo yet';
                badge.style.borderColor = 'rgba(255,255,255,.12)';
            }
        }

        function claimBingo() {
            const name = cardState.playerName || $("#playerName").value.trim() || 'Player';
            const gid = $("#gameId").value.trim() || '‚Äî';
            const gameKey = cardState.gameKey || $("#gameKey").value.trim() || '‚Äî';
            const cardID = cardState.cardID || '‚Äî';
            const {
                lines,
                full
            } = checkLines();
            let tier = full ? 'FULL HOUSE' : (lines >= 2 ? 'DOUBLE LINE' : (lines >= 1 ? 'SINGLE LINE' : 'NO BINGO'));
            if(tier === 'NO BINGO') {
                toast('You don\'t have a winning pattern yet!');
                return;
            }
            const msg = `BINGO CLAIM\nName: ${name}\nGame ID: ${gid}\nGame Key: ${gameKey}\nCard ID: ${cardID}\nStatus: ${tier}`;
            navigator.clipboard.writeText(msg).then(() => toast('Claim copied. Paste in chat + send screenshot.'));
        }

        function togglePaste() {
            $("#pasteWrap").classList.toggle('hidden');
        }

        function applyCalledFromPaste() {
            const txt = $("#pasteInput").value.toUpperCase();
            const nums = txt.match(/\b([BIOGN]?\s*\d{1,2})\b/g) || [];
            const set = new Set(nums.map(s => parseInt(s.replace(/[^0-9]/g, ''), 10)).filter(n => n >= 1 && n <= 75));
            cardState.cells.forEach((cell, idx) => {
                if (typeof cell.n === 'number' && set.has(cell.n)) {
                    cardState.cells[idx].marked = true;
                    const div = cardState.gridEl.children[idx];
                    if(div) {
                        div.classList.add('marked');
                        div.setAttribute('aria-pressed', 'true');
                    }
                }
            });
            updateStatus();
            toast('Applied called numbers');
        }

        function clearCalled() {
            $("#pasteInput").value = '';
            toast('Cleared');
        }

        function downloadCardPNG() {
            if (cardState.cells.length !== 25) {
                toast('Generate a card first');
                return;
            }

            const scale = 4, size = 500, pad = 20;
            const c = document.createElement('canvas');
            c.width = size * scale;
            c.height = size * scale;
            const ctx = c.getContext('2d');
            ctx.scale(scale, scale);

            ctx.fillStyle = '#0b1020';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff';
            ctx.globalAlpha = .08;
            ctx.fillRect(0, 0, size, size);
            ctx.globalAlpha = 1;

            ctx.font = 'bold 16px Inter';
            ctx.fillStyle = '#cfd8ff';
            ctx.textAlign = 'left';
            const name = cardState.playerName || 'Player';
            const gid = $("#gameId").value.trim() || '‚Äî';
            const cardID = cardState.cardID || '‚Äî';
            const gameKey = cardState.gameKey || $("#gameKey").value.trim() || '‚Äî';
            
            ctx.fillText(`Game: ${gid} | Key: ${gameKey}`, pad, pad + 18);
            ctx.fillText(`Player: ${name} | Card ID: ${cardID}`, pad, pad + 38);

            const headers = ['B', 'I', 'N', 'G', 'O'];
            const headerY = pad + 60;
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = '#cfd8ff';
                ctx.font = 'bold 26px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(headers[i], pad + (i + 0.5) * (size - pad * 2) / 5, headerY);
            }

            const cell = (size - pad * 2) / 5;
            const gridY = headerY + 16;
            for (let r = 0; r < 5; r++) {
                for (let cidx = 0; cidx < 5; cidx++) {
                    const i = r * 5 + cidx;
                    const val = cardState.cells[i].n;
                    const x = pad + (cidx + 0.5) * cell;
                    const y = gridY + (r + 1) * cell - 12;

                    ctx.strokeStyle = 'rgba(255,255,255,.25)';
                    ctx.strokeRect(pad + cidx * cell, gridY + r * cell, cell, cell);

                    if (val === 'FREE') {
                        ctx.fillStyle = '#9ef0ff';
                        ctx.font = 'bold 18px Inter';
                        ctx.fillText('FREE', x, y);
                    } else {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 20px Inter';
                        ctx.fillText(String(val), x, y);
                    }
                }
            }

            const url = c.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bingo-card.png';
            a.click();
        }

        const caller = {
            deck: [],
            called: [],
        };

        function startCaller() {
            const gid = $("#hostGameId").value.trim();
            if (!gid) {
                toast('Enter a Game ID');
                return;
            }
            const deck = Array.from({
                length: 75
            }, (_, i) => i + 1);
            
            function seededShuffle(array, seed) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random(seed) * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            caller.deck = seededShuffle(deck, gid);
            caller.called = [];
            renderBoard();
            $("#lastCall").textContent = '‚Äî';
            $("#btnNext").disabled = false;
            $("#btnUndo").disabled = true;
            $("#btnExport").disabled = true;
            $("#history").textContent = '';
            toast('Caller ready');
        }

        function prefix(n) {
            if (n <= 15) return 'B';
            if (n <= 30) return 'I';
            if (n <= 45) return 'N';
            if (n <= 60) return 'G';
            return 'O';
        }

        function drawNext() {
            if (!caller.deck.length) {
                toast('No more numbers');
                return;
            }
            const n = caller.deck.shift();
            caller.called.push(n);
            $("#lastCall").textContent = prefix(n) + ' ' + n;
            $("#btnUndo").disabled = false;
            $("#btnExport").disabled = false;
            renderBoard();
            $("#history").textContent = caller.called.map(x => prefix(x) + x).join('  ');
        }

        function undoCall() {
            const last = caller.called.pop();
            if (last === undefined) return;
            caller.deck.unshift(last);
            $("#lastCall").textContent = caller.called.length ? (prefix(caller.called.at(-1)) + ' ' + caller.called.at(-1)) : '‚Äî';
            $("#btnUndo").disabled = caller.called.length === 0;
            $("#btnExport").disabled = caller.called.length === 0;
            renderBoard();
            $("#history").textContent = caller.called.map(x => prefix(x) + x).join('  ');
        }

        function renderBoard() {
            const el = $("#board");
            el.innerHTML = '';
            for (let n = 1; n <= 75; n++) {
                const d = document.createElement('div');
                d.className = 'num';
                d.textContent = n;
                if (caller.called.includes(n)) d.classList.add('hit');
                el.appendChild(d);
            }
        }

        function copyShare() {
            const gid = $("#hostGameId").value.trim();
            const txt = `Join HABESHA BINGO!\nGame ID: ${gid}\nHow to play: go to the site, choose Player, enter Game ID, and join the stream.`;
            navigator.clipboard.writeText(txt).then(() => toast('Share text copied'));
        }

        function exportHistory() {
            const blob = new Blob([caller.called.map(x => prefix(x) + x).join(', ')], {
                type: 'text/plain'
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bingo-history.txt';
            a.click();
        }

        function loadPrefs() {
            const p = JSON.parse(localStorage.getItem('qb_player') || 'null');
            if (p) {
                $("#playerName").value = p.name || '';
                $("#gameId").value = p.gid || '';
                $("#gameKey").value = p.gameKey || '';
                if (p.cardID) {
                    generateCardFromSeed(p.cardID, p.name, p.gid, p.gameKey);
                }
            }
        }

        function generateCardFromSeed(cardID, name, gid, gameKey) {
            const ranges = buildRanges();
            const columns = [
                generateColumn(ranges[0], 5),
                generateColumn(ranges[1], 5),
                generateColumn(ranges[2], 5),
                generateColumn(ranges[3], 5),
                generateColumn(ranges[4], 5),
            ];
            columns[2][2] = 'FREE';

            cardState.cells = [];
            cardState.gridEl.innerHTML = '';
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const idx = r * 5 + c;
                    const val = columns[c][r];
                    const cell = {
                        n: val,
                        marked: val === 'FREE',
                        free: val === 'FREE',
                        r,
                        c
                    };
                    cardState.cells.push(cell);

                    const div = document.createElement('div');
                    div.className = 'cell' + (cell.free ? ' free marked' : '');
                    div.textContent = (cell.n === 'FREE') ? '‚òÖ FREE' : cell.n;
                    div.setAttribute('role', 'button');
                    div.setAttribute('aria-pressed', cell.marked ? 'true' : 'false');
                    div.addEventListener('click', () => toggleMark(idx, div));
                    cardState.gridEl.appendChild(div);
                }
            }
            cardState.cardID = cardID;
            cardState.playerName = name;
            cardState.gameKey = gameKey;
            $("#cardDetails").innerHTML = `<b>Game ID:</b> ${gid} ‚Ä¢ <b>Player:</b> ${name} ‚Ä¢ <b>Card ID:</b> <span class="mono">${cardID}</span>`;
            updateStatus();
            $("#generateBtn").disabled = true;
        }

        function verifyCardID() {
            const verifyName = $("#verifyName").value.trim();
            const verifyID = $("#verifyCardID").value.trim().toUpperCase();
            const hostGameId = $("#hostGameId").value.trim();
            const verifyGameKey = $("#verifyGameKey").value.trim();

            const statusEl = $("#verificationStatus");
            statusEl.style.display = 'block';

            if (!verifyName || !verifyID || !hostGameId || !verifyGameKey) {
                statusEl.innerHTML = '<span style="color:var(--danger)">Please fill out all fields.</span>';
                return;
            }
            if (verifyGameKey !== HOST_GAME_KEY) {
                statusEl.innerHTML = '<span style="color:var(--danger)">‚ùå INVALID GAME KEY.</span>';
                return;
            }

            const cardDataString = `${verifyName}|${hostGameId}|${verifyGameKey}`;
            const generatedCardID = btoa(cardDataString).toUpperCase().substring(0, 5);
            
            if (generatedCardID === verifyID) {
                statusEl.innerHTML = `<span style="color:var(--accent); font-weight:700;">‚úÖ VALID CARD ID!</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:var(--danger); font-weight:700;">‚ùå INVALID CARD ID.</span><br>The ID for this name is: <span class="mono" style="color:var(--text)">${generatedCardID}</span>`;
            }
        }

        function onReady() {
            loadPrefs();
            renderBoard();
            checkPlayerInputs();
            calculatePrize();
        }

        document.addEventListener('DOMContentLoaded', onReady);
    </script>
</body>
</html>
